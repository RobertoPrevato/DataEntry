/*!
 * DataEntry v1.0.1, forms validation library that implements Promise based validation of fields and forms,
 * automatic decoration of fields, localized error messages.
 * https://github.com/RobertoPrevato/DataEntry
 *
 * Copyright 2016, Roberto Prevato
 * http://ugrose.com
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
!function(a){if("undefined"!=typeof module&&module.exports)module.exports=a(this);else if("function"==typeof define&&define.amd){var b=this;define("dataentry",function(){return a(b)})}else this.Forms=a(this)}(function(a){function b(a){return typeof a==_}function c(a){return typeof a==aa}function d(a){return typeof a==ba}function e(a){return typeof a==$&&a.constructor==Object}function f(a,b){return a&&a.hasOwnProperty(b)}function g(a,b){for(var c=0,d=a[ca];d>c;c++)if(b(a[c]))return a[c]}function h(a){return typeof HTMLElement===$?a instanceof HTMLElement:a&&typeof a===$&&null!==a&&1===a.nodeType&&typeof a.nodeName===_}function i(a,b){return Y.t("errors."+a,b)}function j(a,b,c){if(b.search(/\s/)>-1){b=b.split(/\s/g);for(var d=0,e=b[ca];e>d;d++)j(a,b[d],c)}else typeof b==_&&a.classList[c?"add":"remove"](b);return a}function k(a,b){return j(a,b,1)}function l(a,b){return j(a,b,0)}function m(a,b){return a&&a.classList.contains(b)}function n(a,b){return a.getAttribute(b)}function o(a){return n(a,"name")}function q(a){return"[name='"+o(a)+"']"}function r(a,b){a.value!=b&&(a.value=b,a.dispatchEvent(new Event("change"),{forced:!0}))}function s(a){var b=/input/i.test(a.tagName);if(b)switch(n(a,"type")){case"radio":case"checkbox":return a.checked}return a.value}function t(a){return a&&/^input$/i.test(a.tagName)&&/^(radio)$/i.test(a.type)}function u(a){return a&&(/^select$/i.test(a.tagName)||t(a))}function v(a){return a.nextElementSibling}function w(a,b){var c=a.nextElementSibling;return m(c,b)?c:Z}function x(a,b){return a.querySelectorAll(b)}function y(a,b){return a.querySelectorAll(b)[0]}function z(a){var b=window.getComputedStyle(a);return"none"==b.display||"hidden"==b.visibility}function A(a){return document.createElement(a)}function B(a){a&&a.parentElement.removeChild(a)}function C(a,b){a.parentNode.insertBefore(b,a.nextSibling)}function D(a,b){a.appendChild(b)}function E(a){return typeof a==$&&a[ca]?H(a,function(a){return a}):Array.prototype.slice.call(arguments)}function F(a){return fa(a)?[].concat.apply([],H(a,F)):a}function G(a,b){if(e(a)){for(var c in a)b(a[c],c);return a}if(!a||!a[ca])return a;for(var d=0,f=a[ca];f>d;d++)b(a[d],d)}function H(a,b){if(!a||!a[ca])return a;for(var c=[],d=0,e=a[ca];e>d;d++)c.push(b(a[d]));return c}function I(a,b){return a.indexOf(b)>-1}function J(a,b){for(var c=0,d=a[ca];d>c;c++)if(b(a[c]))return!0;return!1}function K(a,b){for(var c=[],d=0,e=a[ca];e>d;d++)b(a[d])&&c.push(a[d]);return c}function L(a,b,c){var d={};if(c)for(var e in a)-1==b.indexOf(e)&&(d[e]=a[e]);else for(var g=0,h=b[ca];h>g;g++){var i=b[g];f(a,i)&&(d[i]=a[i])}return d}function M(){var a=arguments;if(a[ca]){if(1==a[ca])return a[0];for(var b,c,d=a[0],e=1,f=a[ca];f>e;e++)if(b=a[e])for(c in b)d[c]=b[c];return d}}function N(a,b,c){var d=function(){return b.apply(this,[a].concat(E(arguments)))};return d.bind(c||this),d}function O(a){return d(a)?O(a()):a}function P(a){setTimeout(a,0)}function Q(a){return a?/select/i.test(a.tagName)&&z(a)&&m(a,"chosen-select")?v(a):a:void 0}function R(a){return t(a)?x(this.dataentry.element,q(a))[0]:a}function S(a){var b=R.call(this,a);return b=Q.call(this,b)}function T(a,b){return a.match(b)}function U(a){var b="selectionStart",c="selectionEnd",d=a.target,e=d.value,f=a.keyCode||a.charCode,g=String.fromCharCode(f),h=(e.substr(d[b],d[c]),e.substr(0,d[b])),i=e.substr(d[c],e.length);return[h,g,i].join("")}function V(a,b){return{error:!0,message:a,field:b[0],params:b}}var W={};W.Version="1.0.1";var X=function(a,b){throw"Error: "+a+(b?" `"+b+"`":"")+" https://github.com/RobertoPrevato/DataEntry/wiki/Errors#"+a};a.Promise||X(1);var Y;a.I?Y=a.I:a.I18n?Y=a.I18n:X(2);var Z,$="object",_="string",aa="number",ba="function",ca="length",da="replace",ea="schema",fa=function(a){return a instanceof Array};W.Utils={};var ga=W.Utils.String={format:function(a){var b=Array.prototype.slice.call(arguments,1);return a[da](/{(\d+)}/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})},trim:function(a){return b(a)?a[da](/^[\s]+|[\s]+$/g,""):a},removeMultipleSpaces:function(a){return b(a)?a[da](/\s{2,}/g," "):a},removeLeadingSpaces:function(a){return b(a)?a[da](/^\s+|\s+$/,""):a},hyphenize:function(a){if(!a)return"";for(;/[A-Z]/.test(a);)a=a[da](/([a-z]?)([A-Z])/g,function(a,b,c){return b+(b?"-":"")+c.toLowerCase()});return a}},ha=W.Harvesting={},ia=ha.DomHarvester=function(a){return this.initialize(a)};M(ia.prototype,{initialize:function(a){var b=this;return b.dataentry=a,b.element=a.element,b},dispose:function(){var a=this;return a.dataentry=a.element=null,a},getValues:function(){var a=this;return a.getValuesFromElement(a.element)},getValuesFromElement:function(a){var b={},c=this;a||(a=c.element);for(var d=x(a,"input,select,textarea"),e=0,f=d[ca];f>e;e++){var g=d[e],h=o(g);h&&!c.isSilent(g)&&(b[h]=c.getValueFromElement(g))}return b},isSilent:function(a){return m(a,"ug-silent")},getValueFromElement:function(a){if(c(a[ca])&&!h(a)){if(!a[ca])return;if(a[ca]>1){if(t(a[0])){var b=g(a,function(a){return a.checked});return b?b.value:Z}var d=[];return G(a,function(a){d.push(s(a))}),d}a=a[0]}var e=this,f=o(a);return f&&!e.isSilent(a)?s(a):void 0},getFieldValue:function(a,b){return a||X(12),this.getValueFromElement(b?b:x(this.element,'[name="'+a+'"]'))}});var ja=ha.ContextHarvester=function(a){return this.initialize(a)};M(ja.prototype,{initialize:function(a){a.context&&a.context.dataentryObjectGetter||X(15);var b=this;return b.dataentry=a,b},dispose:function(){var a=this;return a.dataentry=a.element=null,a},getValues:function(){return this.getValuesFromContext(this.getContext())},getContext:function(){var a=this.dataentry.context.dataentryObjectGetter();return O(a)},getValuesFromContext:function(a){var b,c={},d=this.dataentry.schema;for(b in d)if(f(a,b)){var e=O(a[b]);c[b]=e}return c},getFieldValue:function(a){var b=this.getContext();return f(b,a)?O(b[a]):null}});var ka=W.Marking={},la=ka.Utils={checkElement:S,checkGroup:R,checkChosen:Q},ma=ka.DomMarker=function(a){return this.initialize(a)};M(ma.prototype,la,{initialize:function(a){return this.dataentry=a,this.markStyle=a.options.markStyle,this},dispose:function(){return this.dataentry=null,this},getMessageElement:function(a,b){var c=this;if("tooltips"==c.markStyle){var d="ug-validation-wrapper",e=w(a,d);return e?e:b?c.getTooltipElement(a,b):null}var d="ug-message-element",e=w(a,d);return e?e:b?(e=A("span"),k(e,d),e):null},getOptions:function(a){var c=this.dataentry.schema[a.name],d=this.defaults,e=c?c.message:"right";return b(e)&&(e={position:e}),M({},d,e)},defaults:{position:"right"},getTooltipElement:function(a,b){var c="div",d=this.getOptions(a);return wrapper=A(c),tooltip=A(c),arrow=A(c),p=A("p"),k(wrapper,"ug-validation-wrapper"),k(tooltip,"tooltip validation-tooltip in "+d.position),k(arrow,"tooltip-arrow"),k(p,"tooltip-inner"),D(wrapper,tooltip),D(tooltip,arrow),D(tooltip,p),wrapper},setElementText:function(a,b){var c="textContent";return"tooltips"==this.markStyle?void(y(a,".tooltip-inner")[c]=b):void(a[c]=b)},removeMessageElement:function(a){var b=this;b.checkElement.call(b,a);var c=b.getMessageElement(a,!1);return c&&B(c),b},markFieldNeutrum:function(a){var b=this;return a=S.call(b,a),l(a,"ug-field-invalid ug-field-valid"),b.removeMessageElement(a)},markFieldValid:function(a){var b=this;return a=S.call(b,a),k(l(a,"ug-field-invalid"),"ug-field-valid"),b.removeMessageElement(a)},markFieldInfo:function(a,b){var c=this;a=S.call(c,a);var d=c.getMessageElement(a,!0);return c.setElementText(k(d,"ug-info"),b.message),C(a,d),c},markFieldInvalid:function(a,b){var c=this;a=S.call(c,a);var d=c.getMessageElement(a,!0);return c.setElementText(k(d,"ug-error"),b.message),C(a,d),c},markFieldTouched:function(a){return a=S.call(this,a),k(a,"ug-touched"),this},removeElements:function(){var a="tooltips"==this.markStyle?".ug-validation-wrapper":".ug-message-element";return G(x(this.dataentry.element,a),B),this}});var na=W.Formatting={SetValue:r,Rules:{trim:{fn:function(a,b){var c=/^[\s]+|[\s]+$/g;b.match(c)&&r(a,b[da](c,""))}},removeSpaces:{fn:function(a,b){var c=/\s/g;b.match(c)&&r(a,b[da](c,""))}},removeMultipleSpaces:{fn:function(a,b){var c=/\s{2,}/g;b.match(c)&&r(a,b[da](c," "))}},cleanSpaces:{fn:function(a,b){if(b){var c=ga.trim(ga.removeMultipleSpaces(b));c!=b&&r(a,c)}}},integer:{fn:function(a,b){b&&/^0+/.test(b)&&r(a,b[da](/^0+/,""))}}},PreRules:{integer:{fn:function(a,b){/^0+$/.test(b)&&r(a,"")}}}},oa=W.Formatting.Formatter=function(a){return this.initialize(a)};M(oa.prototype,{initialize:function(a){var b=na.Rules,c=this;return c.rules=b,c.dataentry=a,c.marker=a.marker,c},dispose:function(){var a=this;return a.rules=a.dataentry=a.marker=null,a},format:function(a,c,d,e){var f=this;if(b(a)){var g=a;return f.rules[g]?f.rules[g].fn.apply(c,[d,e]):X(4,g),f}for(var h=0,i=a[ca];i>h;h++)f.format(a[h],c,d,e);return f},markFieldFormatted:function(a,b){return this.marker.markFieldInfo(a,b),this}});var pa=function(a,b){return!!(I([8,0,37,39,9],b)||a.ctrlKey&&I([120,118,99,97,88,86,67],b))},qa=function(a){return String.fromCharCode(a)},ra=W.Constraints={PermittedCharacters:pa,StringFromCode:qa,ForeseeValue:U,integer:function(a,b){var b=a.keyCode||a.charCode,c=qa(b);return!(!pa(a,b)&&!T(c,/[0-9]/))},letters:function(a,b){var b=a.keyCode||a.charCode,c=qa(b);return!(!pa(a,b)&&!T(c,/[a-zA-Z]/))},digits:function(a,b){var b=a.keyCode||a.charCode,c=qa(b);return!(!pa(a,b)&&!T(c,/\d/))}};W.Validation={GetError:V,LocalizeError:i,Rules:{none:{fn:function(){return!0}},noSpaces:{fn:function(a,b,c){return b&&b.match(/\s/)?V(i("spacesInValue"),arguments):!0}},remote:{deferred:!0,fn:function(a,b,c,d){return d||X(7),d.apply(a,arguments)}},required:{fn:function(a,c,d,e){b(e)&&(e={message:e});var f={message:i(u(a)?"selectValue":"emptyValue")},g=M(f,e);if(t(a)){var h=x(this.element,q(a));return J(h,function(a){return a.checked})?!0:V(g.message,arguments)}return!c||c.toString().match(/^\s+$/)?V(g.message,arguments):!0}},integer:{fn:function(a,b,d,e){if(!b)return!0;if(!/^\d+$/.test(b))return V(i("notInteger"),arguments);if(e){var f=parseInt(b);if(c(e.min)&&f<e.min)return V(i("minValue",e),arguments);if(c(e.max)&&f>e.max)return V(i("maxValue",e),arguments)}return!0}},letters:{fn:function(a,b,c){return b?/^[a-zA-Z]+$/.test(b)?!0:V(i("canContainOnlyLetters"),arguments):!0}},digits:{fn:function(a,b,c){return b?/^\d+$/.test(b)?!0:V(i("canContainOnlyDigits"),arguments):!0}},maxLength:{fn:function(a,b,c,d){return b&&b[ca]>d?V(i("maxLength",{length:d}),arguments):!0}},minLength:{fn:function(a,b,c,d){return b&&b[ca]<d?V(i("minLength",{length:d}),arguments):!0}},mustCheck:{fn:function(a,b,c,d){return a.checked?!0:V(i("mustBeChecked"),arguments)}}}};var sa=W.Validation.Validator=function(a){return this.initialize(a)};M(sa.prototype,{ev:"blur",defaults:{invalidClass:"ug-field-invalid",message:i("invalidValue"),params:[]},initialize:function(a){var b=this,c=W.Validation.Rules;return b.rules=c,b.dataentry=a,b.context=a,b.marker=a.marker,b},dispose:function(){var a=this;return a.marker=a.rules=a.options=a.context=a.dataentry=null,a},checkValidator:function(a){this.rules[a]||X(3,a)},getValidator:function(a){var c=this,d=c.defaults,f=c.rules;return b(a)?(c.checkValidator(a),M({name:a},d,f[a])):e(a)?(a.name||X(6),c.checkValidator(a.name),M({},d,a,f[a.name])):void X(14)},getValidators:function(a){var b={direct:[],deferred:[]},c=this;return G(a,function(a){var d=c.getValidator(a);d.deferred?b.deferred.push(d):b.direct.push(d)}),b},validate:function(a,b,c,d){var e=this.getValidationChain(a);return this.chain(e,b,c,d)},getValidationChain:function(a){var b=this.getValidators(a),c=[],d=this;return G(b.direct,function(a){a.fn=d.makeValidatorDeferred(a.fn),c.push(a)}),G(b.deferred,function(a){c.push(a)}),c},makeValidatorDeferred:function(a){var b=this;return N(a,function(a){var c=E(arguments);return new Promise(function(d,e){var f=a.apply(b.context,c.slice(1,c[ca]));d(f)})})},chain:function(a){if(!a[ca])return new Promise(function(a){a([])});a=H(a,function(a){return d(a)?{fn:a,params:[]}:a});var b=0,c=[],e=this,f=E(arguments).slice(1,arguments[ca]);return new Promise(function(d,g){function h(a){return a.field||(a.field=this),c.push(a),a.error?d(c):void k()}function j(a){c.push({error:!0,message:i("failedValidation")}),g(c)}function k(){b++,b==a[ca]?d(c):a[b].fn.apply(e.context,f.concat(a[b].params)).then(h,j)}a[b].fn.apply(e.context,f.concat(a[b].params)).then(h,j)})}});var ta=W.DataEntry=function(a){a||X(8),a.element||X(8),a[ea]||X(8);var b=this;b.baseProperties;return M(b,L(a,b.baseProperties)),b.options=M({},b.defaults,L(a,b.baseProperties,1)),b.initialize(a)};return M(ta.prototype,{defaults:{allowImplicitConstraints:!0,allowImplicitFormat:!0,markStyle:"tooltips"},baseProperties:["element","schema","context","events"],initialize:function(a){var b=this;return b.marker=new b.markerType(b),b.harvester=new b.harvesterType(b),b.validator=new b.validatorType(b),b.formatter=new b.formatterType(b),b.fn={},b.handlers=[],b.bindEvents().checkElement(),k(b.element,"ug-dataentry"),b},dispose:function(){var a=this;return a.removeValidation().undelegateEvents(),G(["validator","formatter","harvester","marker"],function(b){a[b].dispose(),a[b]=null}),a.fn=a.element=null,a},string:ga,harvesterType:ia,markerType:ma,validatorType:sa,formatterType:oa,validate:function(a,b){var c=this;a&&d(a)&&(a=a.call(c)),a&&!fa(a)&&X(9),c.element||X(10);var e=c[ea];e||X(11);var f=c.context||c;return new Promise(function(d,g){var h=[];for(var i in e)a&&!I(a,i)||h.push(c.validateField(i,b));Promise.all(h).then(function(a){var b=F(a),e=K(b,function(a){return a&&a.error});e[ca]?(e[0].field.focus(),d.call(f,{valid:!1,errors:e})):d.call(f,{valid:!0,values:c.harvester.getValues()})},function(a){g.apply(f,[a])})})},validateField:function(a,b){b=M({elements:null,decorateField:!0,onlyIfTouched:!1},b||{});var c=this,d=c[ea];a||X(12),d||X(11),d[a]&&d[a].validation||X(13,a);var e=b.elements?b.elements:x(c.element,"[name='"+a+"']");if(e[ca]){var f=c.validator,h=f.marker,i=d[a],j=c.getFieldValidationDefinition(i.validation),k=[];return G(e,function(d){var e=c.getFieldValue(a,d);b.decorateField&&h.markFieldNeutrum(d);var i;i=b.decorateField?f.validate(j,d,e).then(function(a){for(var b=0,c=a[ca];c>b;b++){var e=a[b];if(e.error)return h.markFieldInvalid(d,{message:e.message}),a}return h.markFieldValid(d),a},function(a){var b=g(a,function(a){return a.error});h.markFieldInvalid(d,{message:b.message})}):f.validate(j,d,e),k.push(i)}),new Promise(function(a,b){Promise.all(k).then(function(){a(E(arguments))})})}},getFieldValidationDefinition:function(a){return d(a)?a.apply(this.context||this,[]):a},getFieldValue:function(a,b){var c=this[ea][a];return c.valueGetter?c.valueGetter.call(this.context,b):this.harvester.getFieldValue(a,b)},bindEvents:function(){return this.delegateEvents()},delegateEvents:function(){var a=this,b=a.getEvents(),c=a.element,e=/^(\S+)\s*(.*)$/;for(var f in b){var g=b[f];if(d(g)||(g=a.fn[g]),g){var h=f.match(e),i=h[1],j=h[2];g=g.bind(a),a.setEventListener(c,i,j,g)}}return a},setEventListener:function(a,b,c,d){var e=function(b){var e=(b.currentTarget,x(a,c));if(J(e,function(a){return b.target===a})){var f=d(b);return f===!1&&b.preventDefault(),f}};return this.handlers.push({type:b,fn:e}),a.addEventListener(b,e,!0),this},undelegateEvents:function(){var a=this,b=a.element;return G(a.handlers,function(a){b.removeEventListener(a.type,a.fn,!0)}),a.handlers=[],a},checkElement:function(){var a=this,b=a.element;return b&&/form/i.test(b.tagName)&&b.addEventListener("submit",function(a){a.preventDefault()}),a},getEvents:function(){var a=this,b=a.events||{};return d(b)&&(b=b.call(a)),b=M({},b,a.getValidationDefinition(),a.getPreFormattingDefinition(),a.getMetaEvents(),a.getConstraintsDefinition())},getValidationDefinition:function(){var a=this,c=a[ea],e=a.marker;if(!c)return{};var f,h={};for(f in c){var i=c[f].validationEvent,j=a.string.format("{0} [name='{1}']",i||a.validator.ev,f),k="validation_"+f;h[j]=k,a.fn[k]=function(c,f){if(!a.validationActive)return!0;f==Z&&(f=!1);var h=c.target,i=n(h,"name");e.markFieldNeutrum(h);var j=a[ea][i],k=a.getFieldValidationDefinition(j.validation),l=a.getFieldValue(i,h);a.validator.validate(k,h,l,f).then(function(c){var f=g(c,function(a){return a.error});if(f)e.markFieldInvalid(h,{message:f.message});else{e.markFieldValid(h);var i=n(h,"name"),j=a[ea][i].format;if(d(j)&&(j=j.call(a.context||a,h,l)),j)for(var m=0,o=j[ca];o>m;m++)a.formatter.format(j[m],a,h,l);else if(a.options.allowImplicitFormat)for(var m=0,o=k[ca];o>m;m++){var i=b(k[m])?k[m]:k[m].name;i&&a.formatter.rules[i]&&a.formatter.format(i,a,h,l)}}},function(a){if(a)for(var b=0,c=a[ca];c>b;b++)a[b]&&!a[b].error||e.markFieldInvalid(h,{message:a[b].message})})}}return h},getPreFormattingDefinition:function(){var a=this,b=a[ea];if(!b)return{};var c,d={};for(c in b){var e=a.getFieldPreformatRules(c);if(e&&e[ca]){var f="focus",g=a.string.format('{0} [name="{1}"]',f,c),h="preformat_"+c;d[g]=h,a.fn[h]=function(b,c){for(var d=b.currentTarget,e=n(d,"name"),f=a.getFieldPreformatRules(e),g=0,h=f[ca];h>g;g++){var i=f[g],j=W.Formatting.PreRules[i];j.fn.call(a.context||a,d,s(d))}}}}return d},getFieldPreformatRules:function(a){var b=this,c=b[ea][a];if(!c)return[];var e=c.preformat;if(!e&&b.options.allowImplicitFormat&&!d(c.validation)){e=[];for(var f=b.getFieldValidationDefinition(c.validation),g=0,h=f[ca];h>g;g++){var i=f[g].name||f[g];W.Formatting.PreRules[i]&&e.push(i)}}return e},getMetaEvents:function(){var a=function(a){return this.formatter.marker.markFieldTouched(a.currentTarget),this.validationActive=!0,!0},b=function(a,b){var c=this;c.formatter.marker.markFieldTouched(a.currentTarget),c.validationActive=!0;var d=a.target,e=d.name;if(f(c[ea],e)){var g=/radio/i.test(d.type)?x(c.element,q(d)):[a.target];P(function(){c.validateField(e,{elements:g})})}};return{"keypress input,select,textarea":a,"keydown input,select,textarea":a,"change select":b,"change input[type='radio']":b,"change input[type='checkbox']":b}},autobindFormat:function(){var a=this,c=a[ea],e=a.options;if(c&&!e.strictFormat&&!e.formatBound){for(var g in c){var h=c[g];h.format||(h.format=[]);var i=h.format,j=h.validation;if(j){var j=j;if(d(j))continue;for(var k=0,l=j[ca];l>k;k++){var m=b(j[k])?j[k]:j[k].name;f(a.formatter.rules,m)&&!I(i,m)&&i.push(m)}}}return a.options.formatBound=!0,a}},getConstraintsDefinition:function(){var a=this,c=a[ea];if(!c)return{};var e,g={};for(e in c){var h=a.string.format("{0} [name='{1}']","keypress",e),i="constraint_"+e,j=c[e],k=j.constraint;if(k)d(k)&&(k=k.call(a.context||a)),f(ra,k)?(g[h]=i,a.fn[i]=ra[k]):X(5,k);else if(a.options.allowImplicitConstraints){var l=j.validation;if(l){d(l)&&(l=l.call(a.context||a));for(var m=0,n=l[ca];n>m;m++){var o=b(l[m])?l[m]:l[m].name;f(ra,o)&&(g[h]=i,a.fn[i]=ra[o])}}}}return g},removeValidation:function(a){return this.marker.removeElements(),this}}),W});