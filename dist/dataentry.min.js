/*!
 * DataEntry v1.0.1, forms validation library that implements Promise based validation of fields and forms,
 * automatic decoration of fields, localized error messages.
 * https://github.com/RobertoPrevato/DataEntry
 *
 * Copyright 2016, Roberto Prevato
 * http://ugrose.com
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
!function(a){if("undefined"!=typeof module&&module.exports)module.exports=a(this);else if("function"==typeof define&&define.amd){var b=this;define("dataentry",function(){return a(b)})}else this.Forms=a(this)}(function(a){function b(a){return typeof a==aa}function c(a){return typeof a==ba}function d(a){return typeof a==ca}function e(a){return typeof a==_&&a.constructor==Object}function f(a,b){return a&&a.hasOwnProperty(b)}function g(a,b){for(var c=0,d=a[da];d>c;c++)if(b(a[c]))return a[c]}function h(a){return typeof HTMLElement===_?a instanceof HTMLElement:a&&typeof a===_&&null!==a&&1===a.nodeType&&typeof a.nodeName===aa}function i(a,c){if(b(a))return{name:a};if(e(a)){var d=a.name;return d||Y(c),a}Y(14,d)}function j(a,b){return Z.t("errors."+a,b)}function k(a,b,c){if(b.search(/\s/)>-1){b=b.split(/\s/g);for(var d=0,e=b[da];e>d;d++)k(a,b[d],c)}else typeof b==aa&&a.classList[c?"add":"remove"](b);return a}function l(a,b){return k(a,b,1)}function m(a,b){return k(a,b,0)}function n(a,b){return a&&a.classList.contains(b)}function o(a,b){return a.getAttribute(b)}function q(a){return o(a,"name")}function r(a){return"[name='"+q(a)+"']"}function s(a,b){a.value!=b&&(a.value=b,a.dispatchEvent(new Event("change"),{forced:!0}))}function t(a){var b=/input/i.test(a.tagName);if(b)switch(o(a,"type")){case"radio":case"checkbox":return a.checked}return a.value}function u(a){return a&&/^input$/i.test(a.tagName)&&/^(radio)$/i.test(a.type)}function v(a){return a&&(/^select$/i.test(a.tagName)||u(a))}function w(a){return a.nextElementSibling}function x(a,b){var c=a.nextElementSibling;return n(c,b)?c:$}function y(a,b){return a.querySelectorAll(b)}function z(a,b){return a.querySelectorAll(b)[0]}function A(a){var b=window.getComputedStyle(a);return"none"==b.display||"hidden"==b.visibility}function B(a){return document.createElement(a)}function C(a){a&&a.parentElement.removeChild(a)}function D(a,b){a.parentNode.insertBefore(b,a.nextSibling)}function E(a,b){a.appendChild(b)}function F(a){return typeof a==_&&a[da]?I(a,function(a){return a}):Array.prototype.slice.call(arguments)}function G(a){return ga(a)?[].concat.apply([],I(a,G)):a}function H(a,b){if(e(a)){for(var c in a)b(a[c],c);return a}if(!a||!a[da])return a;for(var d=0,f=a[da];f>d;d++)b(a[d],d)}function I(a,b){if(!a||!a[da])return a;for(var c=[],d=0,e=a[da];e>d;d++)c.push(b(a[d]));return c}function J(a,b){return a.indexOf(b)>-1}function K(a,b){for(var c=0,d=a[da];d>c;c++)if(b(a[c]))return!0;return!1}function L(a,b){if(!a||!a.length)return[];for(var c=[],d=0,e=a[da];e>d;d++)b(a[d])&&c.push(a[d]);return c}function M(a,b,c){var d={};if(c)for(var e in a)-1==b.indexOf(e)&&(d[e]=a[e]);else for(var g=0,h=b[da];h>g;g++){var i=b[g];f(a,i)&&(d[i]=a[i])}return d}function N(){var a=arguments;if(a[da]){if(1==a[da])return a[0];for(var b,c,d=a[0],e=1,f=a[da];f>e;e++)if(b=a[e])for(c in b)d[c]=b[c];return d}}function O(a,b,c){var d=function(){return b.apply(this,[a].concat(F(arguments)))};return d.bind(c||this),d}function P(a){return d(a)?P(a()):a}function Q(a){setTimeout(a,0)}function R(a){return a?/select/i.test(a.tagName)&&A(a)&&n(a,"chosen-select")?w(a):a:void 0}function S(a){return u(a)?y(this.dataentry.element,r(a))[0]:a}function T(a){var b=S.call(this,a);return b=R.call(this,b)}function U(a,b){return a.match(b)}function V(a){var b="selectionStart",c="selectionEnd",d=a.target,e=d.value,f=a.keyCode||a.charCode,g=String.fromCharCode(f),h=(e.substr(d[b],d[c]),e.substr(0,d[b])),i=e.substr(d[c],e.length);return[h,g,i].join("")}function W(a,b){return{error:!0,message:a,field:b[0],params:b}}var X={};X.Version="1.0.1";var Y=function(a,b){throw"Error: "+a+(b?" `"+b+"`":"")+" https://github.com/RobertoPrevato/DataEntry/wiki/Errors#"+a};a.Promise||Y(1);var Z;a.I?Z=a.I:a.I18n?Z=a.I18n:Y(2);var $,_="object",aa="string",ba="number",ca="function",da="length",ea="replace",fa="schema",ga=function(a){return a instanceof Array};X.Utils={};var ha=X.Utils.String={format:function(a){var b=Array.prototype.slice.call(arguments,1);return a[ea](/{(\d+)}/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})},trim:function(a){return b(a)?a[ea](/^[\s]+|[\s]+$/g,""):a},removeMultipleSpaces:function(a){return b(a)?a[ea](/\s{2,}/g," "):a},removeLeadingSpaces:function(a){return b(a)?a[ea](/^\s+|\s+$/,""):a},hyphenize:function(a){if(!a)return"";for(;/[A-Z]/.test(a);)a=a[ea](/([a-z]?)([A-Z])/g,function(a,b,c){return b+(b?"-":"")+c.toLowerCase()});return a}},ia=X.Harvesting={},ja=ia.DomHarvester=function(a){return this.initialize(a)};N(ja.prototype,{initialize:function(a){var b=this;return b.dataentry=a,b.element=a.element,b},dispose:function(){var a=this;return a.dataentry=a.element=null,a},getValues:function(){var a=this;return a.getValuesFromElement(a.element)},getValuesFromElement:function(a){var b={},c=this;a||(a=c.element);for(var d=y(a,"input,select,textarea"),e=0,f=d[da];f>e;e++){var g=d[e],h=q(g);h&&!c.isSilent(g)&&(b[h]=c.getValueFromElement(g))}return b},isSilent:function(a){return n(a,"ug-silent")},getValueFromElement:function(a){if(c(a[da])&&!h(a)){if(!a[da])return;if(a[da]>1){if(u(a[0])){var b=g(a,function(a){return a.checked});return b?b.value:$}var d=[];return H(a,function(a){d.push(t(a))}),d}a=a[0]}var e=this,f=q(a);return f&&!e.isSilent(a)?t(a):void 0},getFieldValue:function(a,b){return a||Y(12),this.getValueFromElement(b?b:y(this.element,'[name="'+a+'"]'))}});var ka=ia.ContextHarvester=function(a){return this.initialize(a)};N(ka.prototype,{initialize:function(a){a.context&&a.context.dataentryObjectGetter||Y(15);var b=this;return b.dataentry=a,b},dispose:function(){var a=this;return a.dataentry=a.element=null,a},getValues:function(){return this.getValuesFromContext(this.getContext())},getContext:function(){var a=this.dataentry.context.dataentryObjectGetter();return P(a)},getValuesFromContext:function(a){var b,c={},d=this.dataentry.schema;for(b in d)if(f(a,b)){var e=P(a[b]);c[b]=e}return c},getFieldValue:function(a){var b=this.getContext();return f(b,a)?P(b[a]):null}});var la=X.Marking={},ma=la.Utils={checkElement:T,checkGroup:S,checkChosen:R},na=la.DomMarker=function(a){return this.initialize(a)};N(na.prototype,ma,{initialize:function(a){return this.dataentry=a,this.markStyle=a.options.markStyle,this},dispose:function(){return this.dataentry=null,this},getMessageElement:function(a,b){var c=this;if("tooltips"==c.markStyle){var d="ug-validation-wrapper",e=x(a,d);return e?e:b?c.getTooltipElement(a,b):null}var d="ug-message-element",e=x(a,d);return e?e:b?(e=B("span"),l(e,d),e):null},getOptions:function(a){var c=this.dataentry.schema[a.name],d=this.defaults,e=c?c.message:"right";return b(e)&&(e={position:e}),N({},d,e)},defaults:{position:"right"},getTooltipElement:function(a,b){var c="div",d=this.getOptions(a);return wrapper=B(c),tooltip=B(c),arrow=B(c),p=B("p"),l(wrapper,"ug-validation-wrapper"),l(tooltip,"tooltip validation-tooltip in "+d.position),l(arrow,"tooltip-arrow"),l(p,"tooltip-inner"),E(wrapper,tooltip),E(tooltip,arrow),E(tooltip,p),wrapper},setElementText:function(a,b){var c="textContent";return"tooltips"==this.markStyle?void(z(a,".tooltip-inner")[c]=b):void(a[c]=b)},removeMessageElement:function(a){var b=this;b.checkElement.call(b,a);var c=b.getMessageElement(a,!1);return c&&C(c),b},markFieldNeutrum:function(a){var b=this;return a=T.call(b,a),m(a,"ug-field-invalid ug-field-valid"),b.removeMessageElement(a)},markFieldValid:function(a){var b=this;return a=T.call(b,a),l(m(a,"ug-field-invalid"),"ug-field-valid"),b.removeMessageElement(a)},markFieldInfo:function(a,b){var c=this;a=T.call(c,a);var d=c.getMessageElement(a,!0);return c.setElementText(l(d,"ug-info"),b.message),D(a,d),c},markFieldInvalid:function(a,b){var c=this;a=T.call(c,a);var d=c.getMessageElement(a,!0);return c.setElementText(l(d,"ug-error"),b.message),D(a,d),c},markFieldTouched:function(a){return a=T.call(this,a),l(a,"ug-touched"),this},removeElements:function(){var a="tooltips"==this.markStyle?".ug-validation-wrapper":".ug-message-element";return H(y(this.dataentry.element,a),C),this}});var oa=X.Formatting={SetValue:s,Rules:{trim:{fn:function(a,b){var c=/^[\s]+|[\s]+$/g;b.match(c)&&s(a,b[ea](c,""))}},removeSpaces:{fn:function(a,b){var c=/\s/g;b.match(c)&&s(a,b[ea](c,""))}},removeMultipleSpaces:{fn:function(a,b){var c=/\s{2,}/g;b.match(c)&&s(a,b[ea](c," "))}},cleanSpaces:{fn:function(a,b){if(b){var c=ha.trim(ha.removeMultipleSpaces(b));c!=b&&s(a,c)}}},integer:{fn:function(a,b){b&&/^0+/.test(b)&&s(a,b[ea](/^0+/,""))}}},PreRules:{integer:{fn:function(a,b){/^0+$/.test(b)&&s(a,"")}}}},pa=X.Formatting.Formatter=function(a){return this.initialize(a)};N(pa.prototype,{initialize:function(a){var b=oa.Rules,c=this;return c.rules=b,c.dataentry=a,c.marker=a.marker,c},dispose:function(){var a=this;return a.rules=a.dataentry=a.marker=null,a},format:function(a,c,d,e,f){var g=this;if(b(a)){var h=a;return g.rules[h]?g.rules[h].fn.call(c,d,e,f):Y(4,h),g}for(var j=0,k=a[da];k>j;j++){var l=i(a[j],16);g.format(l.name,c,d,e,l.params)}return g},markFieldFormatted:function(a,b){return this.marker.markFieldInfo(a,b),this}});var qa=function(a,b){return!!(J([8,0,37,39,9],b)||a.ctrlKey&&J([120,118,99,97,88,86,67],b))},ra=function(a){return String.fromCharCode(a)},sa=X.Constraints={PermittedCharacters:qa,StringFromCode:ra,ForeseeValue:V,integer:function(a,b){var b=a.keyCode||a.charCode,c=ra(b);return!(!qa(a,b)&&!U(c,/[0-9]/))},letters:function(a,b){var b=a.keyCode||a.charCode,c=ra(b);return!(!qa(a,b)&&!U(c,/[a-zA-Z]/))},digits:function(a,b){var b=a.keyCode||a.charCode,c=ra(b);return!(!qa(a,b)&&!U(c,/\d/))}};X.Validation={GetError:W,LocalizeError:j,Rules:{none:{fn:function(){return!0}},noSpaces:{fn:function(a,b,c){return b&&b.match(/\s/)?W(j("spacesInValue"),arguments):!0}},remote:{deferred:!0,fn:function(a,b,c,d){return d||Y(7),d.apply(a,arguments)}},required:{fn:function(a,c,d,e){b(e)&&(e={message:e});var f={message:j(v(a)?"selectValue":"emptyValue")},g=N(f,e);if(u(a)){var h=y(this.element,r(a));return K(h,function(a){return a.checked})?!0:W(g.message,arguments)}return!c||c.toString().match(/^\s+$/)?W(g.message,arguments):!0}},integer:{fn:function(a,b,d,e){if(!b)return!0;if(!/^\d+$/.test(b))return W(j("notInteger"),arguments);if(e){var f=parseInt(b);if(c(e.min)&&f<e.min)return W(j("minValue",e),arguments);if(c(e.max)&&f>e.max)return W(j("maxValue",e),arguments)}return!0}},letters:{fn:function(a,b,c){return b?/^[a-zA-Z]+$/.test(b)?!0:W(j("canContainOnlyLetters"),arguments):!0}},digits:{fn:function(a,b,c){return b?/^\d+$/.test(b)?!0:W(j("canContainOnlyDigits"),arguments):!0}},maxLength:{fn:function(a,b,c,d){return b&&b[da]>d?W(j("maxLength",{length:d}),arguments):!0}},minLength:{fn:function(a,b,c,d){return b&&b[da]<d?W(j("minLength",{length:d}),arguments):!0}},mustCheck:{fn:function(a,b,c,d){return a.checked?!0:W(j("mustBeChecked"),arguments)}}}};var ta=X.Validation.Validator=function(a){return this.initialize(a)};N(ta.prototype,{ev:"blur",defaults:{invalidClass:"ug-field-invalid",message:j("invalidValue"),params:[]},initialize:function(a){var b=this,c=X.Validation.Rules;return b.rules=c,b.dataentry=a,b.context=a,b.marker=a.marker,b},dispose:function(){var a=this;return a.marker=a.rules=a.options=a.context=a.dataentry=null,a},checkValidator:function(a){this.rules[a]||Y(3,a)},getValidator:function(a){var c=this,d=c.defaults,f=c.rules;return b(a)?(c.checkValidator(a),N({name:a},d,f[a])):e(a)?(a.name||Y(6),c.checkValidator(a.name),N({},d,a,f[a.name])):void Y(14)},getValidators:function(a){var b={direct:[],deferred:[]},c=this;return H(a,function(a){var d=c.getValidator(a);d.deferred?b.deferred.push(d):b.direct.push(d)}),b},validate:function(a,b,c,d){var e=this.getValidationChain(a);return this.chain(e,b,c,d)},getValidationChain:function(a){var b=this.getValidators(a),c=[],d=this;return H(b.direct,function(a){a.fn=d.makeValidatorDeferred(a.fn),c.push(a)}),H(b.deferred,function(a){c.push(a)}),c},makeValidatorDeferred:function(a){var b=this;return O(a,function(a){var c=F(arguments);return new Promise(function(d,e){var f=a.apply(b.context,c.slice(1,c[da]));d(f)})})},chain:function(a){if(!a[da])return new Promise(function(a){a([])});a=I(a,function(a){return d(a)?{fn:a,params:[]}:a});var b=0,c=[],e=this,f=F(arguments).slice(1,arguments[da]);return new Promise(function(d,g){function h(a){return a.field||(a.field=this),c.push(a),a.error?d(c):void k()}function i(a){c.push({error:!0,message:j("failedValidation")}),g(c)}function k(){b++,b==a[da]?d(c):a[b].fn.apply(e.context,f.concat(a[b].params)).then(h,i)}a[b].fn.apply(e.context,f.concat(a[b].params)).then(h,i)})}});var ua=X.DataEntry=function(a){a||Y(8),a.element||Y(8),a[fa]||Y(8);var b=this;b.baseProperties;return N(b,M(a,b.baseProperties)),b.options=N({},b.defaults,M(a,b.baseProperties,1)),b.initialize(a)};return N(ua.prototype,{defaults:{allowImplicitConstraints:!0,allowImplicitFormat:!0,markStyle:"tooltips"},baseProperties:["element","schema","context","events"],initialize:function(a){var b=this;return b.marker=new b.markerType(b),b.harvester=new b.harvesterType(b),b.validator=new b.validatorType(b),b.formatter=new b.formatterType(b),b.fn={},b.handlers=[],b.bindEvents().checkElement(),l(b.element,"ug-dataentry"),b},dispose:function(){var a=this;return a.removeValidation().undelegateEvents(),H(["validator","formatter","harvester","marker"],function(b){a[b].dispose(),a[b]=null}),a.fn=a.element=null,a},string:ha,harvesterType:ja,markerType:na,validatorType:ta,formatterType:pa,validate:function(a,b){var c=this;a&&d(a)&&(a=a.call(c)),a&&!ga(a)&&Y(9),c.element||Y(10);var e=c[fa];e||Y(11);var f=c.context||c;return new Promise(function(d,g){var h=[];for(var i in e)a&&!J(a,i)||h.push(c.validateField(i,b));Promise.all(h).then(function(a){var b=G(a),e=L(b,function(a){return a&&a.error});e[da]?(e[0].field.focus(),d.call(f,{valid:!1,errors:e})):d.call(f,{valid:!0,values:c.harvester.getValues()})},function(a){g.apply(f,[a])})})},validateField:function(a,b){b=N({elements:null,decorateField:!0,onlyTouched:!1},b||{});var c=this,d=c[fa];a||Y(12),d||Y(11),d[a]&&d[a].validation||Y(13,a);var e=b.elements?b.elements:y(c.element,"[name='"+a+"']");if(b.onlyTouched&&(e=L(e,function(a){return n(a,"ug-touched")})),e[da]){var f=c.validator,h=f.marker,i=d[a],j=c.getFieldValidationDefinition(i.validation),k=[];return H(e,function(d){var e=c.getFieldValue(a,d);b.decorateField&&h.markFieldNeutrum(d);var i;i=b.decorateField?f.validate(j,d,e).then(function(a){for(var b=0,c=a[da];c>b;b++){var e=a[b];if(e.error)return h.markFieldInvalid(d,{message:e.message}),a}return h.markFieldValid(d),a},function(a){var b=g(a,function(a){return a.error});h.markFieldInvalid(d,{message:b.message})}):f.validate(j,d,e),k.push(i)}),new Promise(function(a,b){Promise.all(k).then(function(){a(F(arguments))})})}},getFieldValidationDefinition:function(a){return d(a)?a.apply(this.context||this,[]):a},getFieldValue:function(a,b){var c=this[fa][a];return c.valueGetter?c.valueGetter.call(this.context,b):this.harvester.getFieldValue(a,b)},bindEvents:function(){return this.delegateEvents()},delegateEvents:function(){var a=this,b=a.getEvents(),c=a.element,e=/^(\S+)\s*(.*)$/;for(var f in b){var g=b[f];if(d(g)||(g=a.fn[g]),g){var h=f.match(e),i=h[1],j=h[2];g=g.bind(a),a.setEventListener(c,i,j,g)}}return a},setEventListener:function(a,b,c,d){var e=function(b){var e=(b.currentTarget,y(a,c));if(K(e,function(a){return b.target===a})){var f=d(b);return f===!1&&b.preventDefault(),f}};return this.handlers.push({type:b,fn:e}),a.addEventListener(b,e,!0),this},undelegateEvents:function(){var a=this,b=a.element;return H(a.handlers,function(a){b.removeEventListener(a.type,a.fn,!0)}),a.handlers=[],a},checkElement:function(){var a=this,b=a.element;return b&&/form/i.test(b.tagName)&&b.addEventListener("submit",function(a){a.preventDefault()}),a},getEvents:function(){var a=this,b=a.events||{};return d(b)&&(b=b.call(a)),b=N({},b,a.getValidationDefinition(),a.getPreFormattingDefinition(),a.getMetaEvents(),a.getConstraintsDefinition())},getValidationDefinition:function(){var a=this,c=a[fa],e=a.marker;if(!c)return{};var f,h={};for(f in c){var i=c[f].validationEvent,j=a.string.format("{0} [name='{1}']",i||a.validator.ev,f),k="validation_"+f;h[j]=k,a.fn[k]=function(c,f){if(!a.validationActive)return!0;f==$&&(f=!1);var h=c.target,i=o(h,"name");e.markFieldNeutrum(h);var j=a[fa][i],k=a.getFieldValidationDefinition(j.validation),l=a.getFieldValue(i,h);a.validator.validate(k,h,l,f).then(function(c){var f=g(c,function(a){return a.error});if(f)e.markFieldInvalid(h,{message:f.message});else{e.markFieldValid(h);var i=o(h,"name"),j=a[fa][i].format;if(d(j)&&(j=j.call(a.context||a,h,l)),j)a.formatter.format(j,a,h,l);else if(a.options.allowImplicitFormat)for(var m=0,n=k[da];n>m;m++){var i=b(k[m])?k[m]:k[m].name;i&&a.formatter.rules[i]&&a.formatter.format(i,a,h,l)}}},function(a){if(a)for(var b=0,c=a[da];c>b;b++)a[b]&&!a[b].error||e.markFieldInvalid(h,{message:a[b].message})})}}return h},getPreFormattingDefinition:function(){var a=this,b=a[fa];if(!b)return{};var c,d={};for(c in b){var e=a.getFieldPreformatRules(c);if(e&&e[da]){var f="focus",g=a.string.format('{0} [name="{1}"]',f,c),h="preformat_"+c;d[g]=h,a.fn[h]=function(b,c){for(var d=b.target,e=o(d,"name"),f=a.getFieldPreformatRules(e),g=0,h=f[da];h>g;g++){var j=i(f[g],16),k=X.Formatting.PreRules[j.name];k.fn.call(a.context||a,d,t(d),j.params)}}}}return d},getFieldPreformatRules:function(a){var b=this,c=b[fa][a];if(!c)return[];var e=c.preformat;if(!e&&b.options.allowImplicitFormat&&!d(c.validation)){e=[];for(var f=b.getFieldValidationDefinition(c.validation),g=0,h=f[da];h>g;g++){var i=f[g].name||f[g];X.Formatting.PreRules[i]&&e.push(i)}}return e},getMetaEvents:function(){var a=function(a){return this.formatter.marker.markFieldTouched(a.target),this.validationActive=!0,!0},b=function(a,b){var c=this;c.formatter.marker.markFieldTouched(a.target),c.validationActive=!0;var d=a.target,e=d.name;if(f(c[fa],e)){var g=/radio/i.test(d.type)?y(c.element,r(d)):[a.target];Q(function(){c.validateField(e,{elements:g})})}};return{"keypress input,select,textarea":a,"keydown input,select,textarea":a,"change select":b,"change input[type='radio']":b,"change input[type='checkbox']":b}},autobindFormat:function(){var a=this,c=a[fa],e=a.options;if(c&&!e.strictFormat&&!e.formatBound){for(var g in c){var h=c[g];h.format||(h.format=[]);var i=h.format,j=h.validation;if(j){var j=j;if(d(j))continue;for(var k=0,l=j[da];l>k;k++){var m=b(j[k])?j[k]:j[k].name;f(a.formatter.rules,m)&&!J(i,m)&&i.push(m)}}}return a.options.formatBound=!0,a}},getConstraintsDefinition:function(){var a=this,c=a[fa];if(!c)return{};var e,g={};for(e in c){var h=a.string.format("{0} [name='{1}']","keypress",e),i="constraint_"+e,j=c[e],k=j.constraint;if(k)d(k)&&(k=k.call(a.context||a)),f(sa,k)?(g[h]=i,a.fn[i]=sa[k]):Y(5,k);else if(a.options.allowImplicitConstraints){var l=j.validation;if(l){d(l)&&(l=l.call(a.context||a));for(var m=0,n=l[da];n>m;m++){var o=b(l[m])?l[m]:l[m].name;f(sa,o)&&(g[h]=i,a.fn[i]=sa[o])}}}}return g},removeValidation:function(a){return this.marker.removeElements(),this}}),X});