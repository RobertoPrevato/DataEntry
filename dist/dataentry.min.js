/*!
 * DataEntry v1.0.1, forms validation library that implements Promise based validation of fields and forms,
 * automatic decoration of fields, localized error messages.
 * https://github.com/RobertoPrevato/DataEntry
 *
 * Copyright 2016, Roberto Prevato
 * http://ugrose.com
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
!function(a){if("undefined"!=typeof module&&module.exports)module.exports=a(this);else if("function"==typeof define&&define.amd){var b=this;define("dataentry",function(){return a(b)})}else this.Forms=a(this)}(function(a){function b(a){return"string"==typeof a}function c(a){return"number"==typeof a}function d(a){return"function"==typeof a}function e(a){return"object"==typeof a&&a.constructor==Object}function f(a,b){for(var c=0,d=a.length;d>c;c++)if(b(a[c]))return a[c]}function g(a){return U.t("errors."+a)}function h(a,b,c){if(b.search(/\s/)>-1){b=b.split(/\s/g);for(var d=0,e=b.length;e>d;d++)h(a,b[d],c)}else"string"==typeof b&&a.classList[c?"add":"remove"](b);return a}function i(a,b){return h(a,b,1)}function j(a,b){return h(a,b,0)}function k(a,b){return a&&a.classList.contains(b)}function l(a,b){return a.getAttribute(b)}function m(a){return l(a,"name")}function n(a){return"[name='"+m(a)+"']"}function o(a,b){a.value=b}function q(a){var b=/input/i.test(a.tagName);if(b)switch(l(a,"type")){case"radio":case"checkbox":return a.checked}return a.value}function r(a){return a&&/^input$/i.test(a.tagName)&&/^(radio)$/i.test(a.type)}function s(a){return a&&(/^select$/i.test(a.tagName)||r(a))}function t(a){return a.nextElementSibling}function u(a,b){var c=a.nextElementSibling;return k(c,b)?c:V}function v(a,b){return a.querySelectorAll(b)}function w(a,b){return a.querySelectorAll(b)[0]}function x(a){var b=window.getComputedStyle(a);return"none"==b.display||"hidden"==b.visibility}function y(a){return document.createElement(a)}function z(a){a&&a.parentElement.removeChild(a)}function A(a,b){a.parentNode.insertBefore(b,a.nextSibling)}function B(a,b){a.appendChild(b)}function C(a){return"object"==typeof a&&a.length?F(a,function(a){return a}):Array.prototype.slice.call(arguments)}function D(a){return X(a)?[].concat.apply([],F(a,D)):a}function E(a,b){if(e(a)){for(var c in a)b(a[c],c);return a}if(!a||!a.length)return a;for(var d=0,f=a.length;f>d;d++)b(a[d],d)}function F(a,b){if(!a||!a.length)return a;for(var c=[],d=0,e=a.length;e>d;d++)c.push(b(a[d]));return c}function G(a,b){return a.indexOf(b)>-1}function H(a,b){for(var c=0,d=a.length;d>c;c++)if(b(a[c]))return!0;return!1}function I(a,b){for(var c=[],d=0,e=a.length;e>d;d++)b(a[d])&&c.push(a[d]);return c}function J(a,b,c){var d={};if(c)for(var e in a)-1==b.indexOf(e)&&(d[e]=a[e]);else for(var f=0,g=b.length;g>f;f++){var h=b[f];a.hasOwnProperty(h)&&(d[h]=a[h])}return d}function K(){var a=arguments;if(a.length){if(1==a.length)return a[0];for(var b,c,d=a[0],e=1,f=a.length;f>e;e++){b=a[e];for(c in b)d[c]=b[c]}return d}}function L(a,b,c){var d=function(){return b.apply(this,[a].concat(C(arguments)))};return d.bind(c||this),d}function M(a){setTimeout(a,0)}function N(a){return a?/select/i.test(a.tagName)&&x(a)&&k(a,"chosen-select")?t(a):a:void 0}function O(a){return r(a)?v(this.dataentry.element,n(a))[0]:a}function P(a){var b=O.call(this,a);return b=N.call(this,b)}function Q(a,b){return a.match(b)}function R(a,b){return{error:!0,message:a,field:b[0],params:b}}var S={};S.Version="1.0.1";var T=function(a,b){throw"Error: "+a+(b?" `"+b+"`":"")+" https://github.com/RobertoPrevato/DataEntry/wiki/Errors#"+a};a.Promise||T(1);var U;a.I?U=a.I:a.I18n?U=a.I18n:T(2);var V,W="schema",X=function(a){return a instanceof Array};S.Utils={};var Y=S.Utils.String={format:function(a){var b=Array.prototype.slice.call(arguments,1);return a.replace(/{(\d+)}/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})},trim:function(a){return b(a)?a.replace(/^[\s]+|[\s]+$/g,""):a},removeMultipleSpaces:function(a){return b(a)?a.replace(/\s{2,}/g," "):a},removeLeadingSpaces:function(a){return b(a)?a.replace(/^\s+|\s+$/,""):a},hyphenize:function(a){if(!a)return"";for(;/[A-Z]/.test(a);)a=a.replace(/([a-z]?)([A-Z])/g,function(a,b,c){return b+(b?"-":"")+c.toLowerCase()});return a}},Z=S.Harvesting={},$=Z.DomHarvester=function(a){return this.initialize(a)};K($.prototype,{initialize:function(a){var b=this;return b.dataentry=a,b.element=a.element,b},dispose:function(){var a=this;return a.dataentry=a.element=null,a},getValues:function(){var a=this;return a.getValuesFromElement(a.element)},getValuesFromElement:function(a){var b={},c=this;a||(a=c.element);for(var d=v(a,"input,select,textarea"),e=0,f=d.length;f>e;e++){var g=d[e],h=m(g);h&&!c.isSilent(g)&&(b[h]=c.getValueFromElement(g))}return b},isSilent:function(a){return k(a,"ug-silent")},getValueFromElement:function(a){var b=this,c=m(a);return c&&!b.isSilent(a)?q(a):void 0},getFieldValue:function(a,b){return a||T(12),this.getValueFromElement(b?b:w(this.element,'[name="'+a+'"]'))}});var _=S.Marking={},aa=_.Utils={checkElement:P,checkGroup:O,checkChosen:N},ba=_.DomMarker=function(a){return this.initialize(a)};K(ba.prototype,aa,{initialize:function(a){return this.dataentry=a,this.markStyle=a.options.markStyle,this},dispose:function(){return this.dataentry=null,this},getMessageElement:function(a,b){var c=this;if("tooltips"==c.markStyle){var d="ug-validation-wrapper",e=u(a,d);return e?e:b?c.getTooltipElement(a,b):null}var d="ug-message-element",e=u(a,d);return e?e:b?(e=y("span"),i(e,d),e):null},getTooltipElement:function(a,b){var c="div";return wrapper=y(c),tooltip=y(c),arrow=y(c),p=y("p"),i(wrapper,"ug-validation-wrapper"),i(tooltip,"tooltip validation-tooltip right in"),i(arrow,"tooltip-arrow"),i(p,"tooltip-inner"),B(wrapper,tooltip),B(tooltip,arrow),B(tooltip,p),wrapper},setElementText:function(a,b){var c="textContent";return"tooltips"==this.markStyle?void(w(a,".tooltip-inner")[c]=b):void(a[c]=b)},removeMessageElement:function(a){var b=this;b.checkElement.call(b,a);var c=b.getMessageElement(a,!1);return c&&z(c),b},markFieldNeutrum:function(a){var b=this;return a=P.call(b,a),j(a,"ug-field-invalid ug-field-valid"),b.removeMessageElement(a)},markFieldValid:function(a){var b=this;return a=P.call(b,a),i(j(a,"ug-field-invalid"),"ug-field-valid"),b.removeMessageElement(a)},markFieldInfo:function(a,b){var c=this;a=P.call(c,a);var d=c.getMessageElement(a,!0);return c.setElementText(i(d,"ug-info"),b.message),A(a,d),c},markFieldInvalid:function(a,b){var c=this;a=P.call(c,a);var d=c.getMessageElement(a,!0);return c.setElementText(i(d,"ug-error"),b.message),A(a,d),c},markFieldTouched:function(a){return a=P.call(this,a),i(a,"ug-touched"),this},removeElements:function(){var a="tooltips"==this.markStyle?".ug-validation-wrapper":".ug-message-element";return E(v(this.dataentry.element,a),z),this}});var ca=S.Formatting={Rules:{trim:{fn:function(a,b){var c=/^[\s]+|[\s]+$/g;b.match(c)&&o(a,b.replace(c,""))}},removeSpaces:{fn:function(a,b){var c=/\s/g;b.match(c)&&o(a,b.replace(c,""))}},removeMultipleSpaces:{fn:function(a,b){var c=/\s{2,}/g;b.match(c)&&o(a,b.replace(c," "))}},cleanSpaces:{fn:function(a,b){if(b){var c=Y.trim(Y.removeMultipleSpaces(b));c!=b&&o(a,c)}}},integer:{fn:function(a,b){b&&/^0+/.test(b)&&o(a,b.replace(/^0+/,""))}}},PreRules:{integer:{fn:function(a,b){/^0+$/.test(b)&&o(a,"")}}}},da=S.Formatting.Formatter=function(a){return this.initialize(a)};K(da.prototype,{initialize:function(a){var b=ca.Rules,c=this;return c.rules=b,c.dataentry=a,c.marker=a.marker,c},dispose:function(){var a=this;return a.rules=a.dataentry=a.marker=null,a},format:function(a,c,d,e){var f=this;if(b(a)){var g=a;return f.rules[g]?f.rules[g].fn.apply(c,[d,e]):T(4,g),f}for(var h=0,i=a.length;i>h;h++)f.format(a[h],c,d,e);return f},markFieldFormatted:function(a,b){return this.marker.markFieldInfo(a,b),this}});var ea=function(a,b){return!!(G([8,0,37,39,9],b)||a.ctrlKey&&G([120,118,99,97,88,86,67],b))},fa=function(a){return String.fromCharCode(a)},ga=S.Constraints={PermittedCharacters:ea,StringFromCode:fa,integer:function(a,b){var b=a.keyCode||a.charCode,c=fa(b);return!(!ea(a,b)&&!Q(c,/[0-9]/))},letters:function(a,b){var b=a.keyCode||a.charCode,c=fa(b);return!(!ea(a,b)&&!Q(c,/[a-zA-Z]/))},digits:function(a,b){var b=a.keyCode||a.charCode,c=fa(b);return!(!ea(a,b)&&!Q(c,/\d/))}};S.Validation={GetError:R,Rules:{none:{fn:function(){return!0}},noSpaces:{fn:function(a,b,c){return b&&b.match(/\s/)?R(g("spacesInValue"),arguments):!0}},remote:{deferred:!0,fn:function(a,b,c,d){return d||T(7),d.apply(a,arguments)}},required:{fn:function(a,c,d,e){b(e)&&(e={message:e});var f={message:g(s(a)?"selectValue":"emptyValue")},h=K(f,e);if(r(a)){var i=v(this.element,n(a));return H(i,function(a){return a.checked})?!0:R(h.message,arguments)}return!c||c.toString().match(/^\s+$/)?R(h.message,arguments):!0}},integer:{fn:function(a,b,d,e){if(!b)return!0;if(!/^\d+$/.test(b))return R(g("notInteger"),arguments);if(e){var f=parseInt(b);if(c(e.min)&&f<e.min)return R(g("minValue",e),arguments);if(c(e.max)&&f>e.max)return R(g("maxValue",e),arguments)}return!0}},letters:{fn:function(a,b,c){return b?/^[a-zA-Z]+$/.test(b)?!0:R(g("canContainOnlyLetters"),arguments):!0}},digits:{fn:function(a,b,c){return b?/^\d+$/.test(b)?!0:R(g("canContainOnlyDigits"),arguments):!0}},maxLength:{fn:function(a,b,c,d){return b&&b.length>d?R(g("maxLength",{length:d}),arguments):!0}},minLength:{fn:function(a,b,c,d){return b&&b.length<d?R(g("minLength",{length:d}),arguments):!0}},mustCheck:{fn:function(a,b,c,d){return a.checked?!0:R(g("mustBeChecked"),arguments)}}}};var ha=S.Validation.Validator=function(a){return this.initialize(a)};K(ha.prototype,{ev:"blur",defaults:{invalidClass:"ug-field-invalid",message:g("invalidValue"),params:[]},initialize:function(a){var b=this,c=S.Validation.Rules;return b.rules=c,b.dataentry=a,b.context=a,b.marker=a.marker,b},dispose:function(){var a=this;return a.marker=a.rules=a.options=a.context=a.dataentry=null,a},checkValidator:function(a){this.rules[a]||T(3,a)},getValidator:function(a){var c=this,d=c.defaults,f=c.rules;return b(a)?(c.checkValidator(a),K({name:a},d,f[a])):e(a)?(a.name||T(6),c.checkValidator(a.name),K({},d,a,f[a.name])):void T(14)},getValidators:function(a){var b={direct:[],deferred:[]},c=this;return E(a,function(a){var d=c.getValidator(a);d.deferred?b.deferred.push(d):b.direct.push(d)}),b},validate:function(a,b,c,d){var e=this.getValidationChain(a);return this.chain(e,b,c,d)},getValidationChain:function(a){var b=this.getValidators(a),c=[],d=this;return E(b.direct,function(a){a.fn=d.makeValidatorDeferred(a.fn),c.push(a)}),E(b.deferred,function(a){c.push(a)}),c},makeValidatorDeferred:function(a){var b=this;return L(a,function(a){var c=C(arguments);return new Promise(function(d,e){var f=a.apply(b.context,c.slice(1,c.length));d(f)})})},chain:function(a){if(!a.length)return new Promise(function(a){a([])});a=F(a,function(a){return d(a)?{fn:a,params:[]}:a});var b=0,c=[],e=this,f=C(arguments).slice(1,arguments.length);return new Promise(function(d,h){function i(a){return a.field||(a.field=this),c.push(a),a.error?d(c):void k()}function j(a){c.push({error:!0,message:g("failedValidation")}),h(c)}function k(){b++,b==a.length?d(c):a[b].fn.apply(e.context,f.concat(a[b].params)).then(i,j)}a[b].fn.apply(e.context,f.concat(a[b].params)).then(i,j)})}});var ia=S.DataEntry=function(a){a||T(8),a.element||T(8),a[W]||T(8);var b=this;b.baseProperties;return K(b,J(a,b.baseProperties)),b.options=K({},b.defaults,J(a,b.baseProperties,1)),b.initialize(a)};return K(ia.prototype,{defaults:{allowImplicitConstraints:!0,allowImplicitFormat:!0,markStyle:"tooltips"},baseProperties:["element","schema","context","events"],initialize:function(a){var b=this;return b.marker=new b.markerType(b),b.harvester=new b.harvesterType(b),b.validator=new b.validatorType(b),b.formatter=new b.formatterType(b),b.fn={},b.handlers=[],b.bindEvents().checkElement(),i(b.element,"ug-dataentry"),b},dispose:function(){var a=this;return a.removeValidation().undelegateEvents(),E(["validator","formatter","harvester","marker"],function(b){a[b].dispose(),a[b]=null}),a.fn=a.element=null,a},string:Y,harvesterType:$,markerType:ba,validatorType:ha,formatterType:da,validate:function(a,b){var c=this;a&&d(a)&&(a=a.call(c)),a&&!X(a)&&T(9),c.element||T(10);var e=c[W];e||T(11);var f=c.context||c;return new Promise(function(d,g){var h=[];for(var i in e)a&&!G(a,i)||h.push(c.validateField(i,b));Promise.all(h).then(function(a){var b=D(a),e=I(b,function(a){return a&&a.error});e.length?(e[0].field.focus(),d.call(f,{valid:!1,errors:e})):d.call(f,{valid:!0,values:c.harvester.getValues()})},function(a){g.apply(f,[a])})})},validateField:function(a,b){b=K({elements:null,decorateField:!0,onlyIfTouched:!1},b||{});var c=this,d=c[W];a||T(12),d||T(11),d[a]&&d[a].validation||T(13,a);var e=b.elements?b.elements:v(c.element,"[name='"+a+"']");if(e.length){var g=c.validator,h=g.marker,i=d[a],j=c.getFieldValidationDefinition(i.validation),k=[];return E(e,function(d){var e=c.getFieldValue(a,d);b.decorateField&&h.markFieldNeutrum(d);var i;i=b.decorateField?g.validate(j,d,e).then(function(a){for(var b=0,c=a.length;c>b;b++){var e=a[b];if(e.error)return h.markFieldInvalid(d,{message:e.message}),a}return h.markFieldValid(d),a},function(a){var b=f(a,function(a){return a.error});h.markFieldInvalid(d,{message:b.message})}):g.validate(j,d,e),k.push(i)}),new Promise(function(a,b){Promise.all(k).then(function(){a(C(arguments))})})}},getFieldValidationDefinition:function(a){return d(a)?a.apply(this.context||this,[]):a},getFieldValue:function(a,b){var c=this[W][a];return c.valueGetter?c.valueGetter.call(this.context,b):this.harvester.getFieldValue(a,b)},bindEvents:function(){return this.delegateEvents()},delegateEvents:function(){var a=this,b=a.getEvents(),c=a.element,e=/^(\S+)\s*(.*)$/;for(var f in b){var g=b[f];if(d(g)||(g=a.fn[g]),g){var h=f.match(e),i=h[1],j=h[2];g=g.bind(a),a.setEventListener(c,i,j,g)}}return a},setEventListener:function(a,b,c,d){var e=function(b){var e=(b.currentTarget,v(a,c));if(H(e,function(a){return b.target===a})){var f=d(b);return f===!1&&b.preventDefault(),f}};return this.handlers.push({type:b,fn:e}),a.addEventListener(b,e,!0),this},undelegateEvents:function(){var a=this,b=a.element;return E(a.handlers,function(a){b.removeEventListener(a.type,a.fn,!0)}),a.handlers=[],a},checkElement:function(){var a=this,b=a.element;return b&&/form/i.test(b.tagName)&&b.addEventListener("submit",function(a){a.preventDefault()}),a},getEvents:function(){var a=this,b=a.events||{};return d(b)&&(b=b.call(a)),b=K({},b,a.getValidationDefinition(),a.getPreFormattingDefinition(),a.getMetaEvents(),a.getConstraintsDefinition())},getValidationDefinition:function(){var a=this,c=a[W],e=a.marker;if(!c)return{};var g,h={};for(g in c){var i=c[g].validationEvent,j=a.string.format("{0} [name='{1}']",i||a.validator.ev,g),k="validation_"+g;h[j]=k,a.fn[k]=function(c,g){if(!a.validationActive)return!0;g==V&&(g=!1);var h=c.target,i=l(h,"name");e.markFieldNeutrum(h);var j=a[W][i],k=a.getFieldValidationDefinition(j.validation),m=a.getFieldValue(i,h);a.validator.validate(k,h,m,g).then(function(c){var g=f(c,function(a){return a.error});if(g)e.markFieldInvalid(h,{message:g.message});else{e.markFieldValid(h);var i=l(h,"name"),j=a[W][i].format;if(d(j)&&(j=j.call(a.context||a,h,m)),j)for(var n=0,o=j.length;o>n;n++)a.formatter.format(j[n],a,h,m);else if(a.options.allowImplicitFormat)for(var n=0,o=k.length;o>n;n++){var i=b(k[n])?k[n]:k[n].name;i&&a.formatter.rules[i]&&a.formatter.format(i,a,h,m)}}},function(a){if(a)for(var b=0,c=a.length;c>b;b++)a[b]&&!a[b].error||e.markFieldInvalid(h,{message:a[b].message})})}}return h},getPreFormattingDefinition:function(){var a=this,b=a[W];if(!b)return{};var c,d={};for(c in b){var e=a.getFieldPreformatRules(c);if(e&&e.length){var f="focus",g=a.string.format('{0} [name="{1}"]',f,c),h="preformat_"+c;d[g]=h,a.fn[h]=function(b,c){for(var d=b.currentTarget,e=l(d,"name"),f=a.getFieldPreformatRules(e),g=0,h=f.length;h>g;g++){var i=f[g],j=S.Formatting.PreRules[i];j.fn.call(a.context||a,d,q(d))}}}}return d},getFieldPreformatRules:function(a){var b=this,c=b[W][a];if(!c)return[];var e=c.preformat;if(!e&&b.options.allowImplicitFormat&&!d(c.validation)){e=[];for(var f=b.getFieldValidationDefinition(c.validation),g=0,h=f.length;h>g;g++){var i=f[g].name||f[g];S.Formatting.PreRules[i]&&e.push(i)}}return e},getMetaEvents:function(){var a=function(a){return this.formatter.marker.markFieldTouched(a.currentTarget),this.validationActive=!0,!0},b=function(a,b){var c=this;c.formatter.marker.markFieldTouched(a.currentTarget),c.validationActive=!0;var d=a.target,e=d.name;if(c[W].hasOwnProperty(e)){var f=/radio/i.test(d.type)?v(c.element,n(d)):[a.target];M(function(){c.validateField(e,{elements:f})})}};return{"keypress input,select,textarea":a,"keydown input,select,textarea":a,"change select":b,"change input[type='radio']":b,"change input[type='checkbox']":b}},autobindFormat:function(){var a=this,c=a[W],e=a.options;if(c&&!e.strictFormat&&!e.formatBound){for(var f in c){var g=c[f];g.format||(g.format=[]);var h=g.format,i=g.validation;if(i){var i=i;if(d(i))continue;for(var j=0,k=i.length;k>j;j++){var l=b(i[j])?i[j]:i[j].name;a.formatter.rules.hasOwnProperty(l)&&!G(h,l)&&h.push(l)}}}return a.options.formatBound=!0,a}},getConstraintsDefinition:function(){var a=this,c=a[W];if(!c)return{};var e,f={};for(e in c){var g=a.string.format("{0} [name='{1}']","keypress",e),h="constraint_"+e,i=c[e],j=i.constraint;if(j)d(j)&&(j=j.call(a.context||a)),ga.hasOwnProperty(j)?(f[g]=h,a.fn[h]=ga[j]):T(5,j);else if(a.options.allowImplicitConstraints){var k=i.validation;if(k){d(k)&&(k=k.call(a.context||a));for(var l=0,m=k.length;m>l;l++){var n=b(k[l])?k[l]:k[l].name;ga.hasOwnProperty(n)&&(f[g]=h,a.fn[h]=ga[n])}}}}return f},removeValidation:function(a){return this.marker.removeElements(),this}}),S});